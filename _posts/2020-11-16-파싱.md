---
layout: post
title: 고속버스 공공데이터포털 api 가져오기
excerpt: "A List of Projects"
project: true
tags: [프로젝트,python,rest api,액셀]
comments: true
---

# 1. 프로젝트 개요

서울 경부 , 센트럴에서 출발하는 고속버스의 배차 횟수 , 배차 시간을 구해서 저장해야할 일이 생겼기 때문에
간단한 프로젝트를 진행하였습니다. 요구사항은 다음과 같습니다.

- 서울 경부 , 센트럴에서 출발하는 고속버스 정보
- 일요일 6시 부터 24시 사이에 운행되는 버스의 수
- 버스 시간표의 배차 간격 최대, 최소, 평균값
- 액셀에 입력

첫번째로 고속버스 데이터를 가져와야 했기떄문에 공공데이터포털 api를 이용하여 데이터를 가져와야 했습니다.
또한 가져온 데이터를 액셀에 저장하여야 했기떄문에 가장 편하고 간단하게 사용할 수 있는 python을 사용 하였습니다.

# 2. 공공데이터포털 api 가져오기

첫번째로 공공 테이터 포털 api를 가져오기 위해선 사이트에 회원가입을 한 후에 활용신청을 하여 인증키를 받아와야 합니다.
제공하는 일일 트래픽은 1000 이며 이 이상 사용하려면 운영계정 신청을 하여야합니다. 

인증 키를 받게되면 이제 데이터를 가져 올 수 있습니다. 데이터를 가져오기 위해서 다음을 import해야합니다.
``` py
from bs4 import BeautifulSoup
import requests
import time
```
그리고 난 후에 기본적으로 데이터를 넘겨주기 위해서 (주소 + 인증키 + 요청변수) 이러한 형식으로 
데이터를 보내야 합니다. 


# 3. API 요청 변수 확인하기

우리가 필요한 정보는 고속 버스의 정보 조회기떄문에 고속 버스 api를 사용해야 합니다. 
[이미지1](.\img\boj\파싱\캡처.PNG)





``` python
from bs4 import BeautifulSoup
import numpy as np
import requests
import time
import heapq
import openpyxl

# 여기에 신청한 본인의 key를 넣어야 합니다!
key = ''

numOfRows = '10000'
pageNo = '1'
naek = []
data = []
# 도시 목록을 가져온다.
def findCityList():
    queryParams = 'ServiceKey='+key+'&numOfRows=' + numOfRows + '&pageNo='+pageNo
    url = 'http://openapi.tago.go.kr/openapi/service/ExpBusInfoService/getExpBusTrminlList?serviceKey='+key+'&numOfRows=1000&pageNo=1'
    req = requests.get(url)
    print(url)
    html = req.text
    soup = BeautifulSoup(html, 'html.parser')
    my_content = soup.select('body > items > item > terminalId')
    for content in my_content:
        naek.append(content.text)


# # 도시목록 end
def convert(strT):
    hour = int(strT[-4:-2])
    min = int(strT[-2:])
    date = int(strT[-8:-4])
    return hour*60+min
    
def sub(str1, str2):
    t1 = convert(str1)
    t2 = convert(str2)
    return t2-t1

def busInfoFind():
    for i in naek:
        # 터미널 코드 => 이름 찾기
        depTerminalId = 'NAEK010' # 출발
        arrTerminalId = i # 도착
        depPlandTime = '20201122' #날짜
        busGradeId = ''
        queryParams = 'ServiceKey='+key+'&depTerminalId='+depTerminalId + '&arrTerminalId='+arrTerminalId+'&depPlandTime='+depPlandTime+'&numOfRows=1000&pageNo=1'
        url = 'http://openapi.tago.go.kr/openapi/service/ExpBusInfoService/getStrtpntAlocFndExpbusInfo?'+queryParams
        # print(url)
        req = requests.get(url)
        html = req.text
        row_index = 1
        soup = BeautifulSoup(html, 'html.parser')
        my_content = []
        my_content = soup.select('body > items > item > depPlandTime')
        arrPlaceNm = []
        arrPlaceNm = soup.select('body > items > item > arrPlaceNm')
        j = 0
        ans = []
        avg = 0
        for content in my_content:
            if convert(content.text)<convert('202011120500'):
                continue
            if j == 0:
                pre = content.text
                j = j+1
                continue
            tmp  = sub(pre,content.text)
            ans.append(tmp)
            avg += tmp
            pre = content.text
            j = j+1
        if arrPlaceNm:
            if ans:
                # 이름 , 배차횟수 , 최소 , 최대 , 평균
                heapq.heappush(data,(arrPlaceNm[0].text,j,min(ans),max(ans),avg/(j-1)))
                # print(arrPlaceNm[0].text)
                # print('최소 = '+str(min(ans)))
                # print('최대 = '+str(max(ans)))
                # print('평균 = '+str(avg/(j-1)))
            else :
                heapq.heappush(data,(arrPlaceNm[0].text,j,0,0,0))

    heapq.heapify(data)

def printData():
    print(data)

def excelInput():
    wb = openpyxl.Workbook()
    sheet1 = wb.active
    for i in range(1,len(data)):   
        for j in range(5):
            sheet1.cell(row = i,column = j+1,value = data[i][j])
    wb.save('고속버스.xlsx')


findCityList()
busInfoFind()
excelInput()
printData()

```